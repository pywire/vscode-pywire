#!/bin/sh -e

ROOT_DIR="$(cd "$(dirname "$0")/.." && pwd)"
TARGET_DIR="$ROOT_DIR/bundled/libs"
if [ -d "$TARGET_DIR" ]; then
    rm -rf "$TARGET_DIR"
fi
mkdir -p "$TARGET_DIR"

PYTHON_BIN="python"
if ! command -v "$PYTHON_BIN" >/dev/null 2>&1; then
    PYTHON_BIN="python3"
fi

resolve_pywire_src() {
    if [ -z "$1" ]; then
        return 1
    fi

    src="$1"
    case "$src" in
        /*) ;;
        *) src="$ROOT_DIR/$src" ;;
    esac

    if [ ! -d "$src" ]; then
        return 1
    fi

    if [ -f "$src/pyproject.toml" ] || [ -f "$src/setup.py" ] || [ -f "$src/setup.cfg" ]; then
        echo "$src"
        return 0
    fi

    return 1
}

get_latest_tag() {
    REPO_URL="$1"
    # Get the latest tag matching v* sorted by version number
    TAG=$(git ls-remote --tags --sort='v:refname' "$REPO_URL" 'refs/tags/v*' | tail -n1 | sed 's|.*refs/tags/||')
    if [ -z "$TAG" ]; then
        echo "main"
    else
        echo "$TAG"
    fi
}

pywire_src="$(resolve_pywire_src "$PYWIRE_SRC")" || pywire_src=""
if [ -z "$pywire_src" ]; then
    pywire_src="$(resolve_pywire_src "../pywire")" || pywire_src=""
fi
if [ -z "$pywire_src" ]; then
    pywire_src="$(resolve_pywire_src "pywire")" || pywire_src=""
fi

pywire_ls_src="$(resolve_pywire_src "$PYWIRE_LANGUAGE_SERVER_SRC")" || pywire_ls_src=""
if [ -z "$pywire_ls_src" ]; then
    pywire_ls_src="$(resolve_pywire_src "../pywire-language-server")" || pywire_ls_src=""
fi
if [ -z "$pywire_ls_src" ]; then
    pywire_ls_src="$(resolve_pywire_src "pywire-language-server")" || pywire_ls_src=""
fi

if [ -n "$pywire_src" ] || [ -n "$pywire_ls_src" ]; then
    set -- pygls pyright
    if [ -n "$pywire_src" ]; then
        set -- "$@" "$pywire_src"
    fi
    if [ -n "$pywire_ls_src" ]; then
        set -- "$@" "$pywire_ls_src"
    fi
    if "$PYTHON_BIN" -m pip --version >/dev/null 2>&1; then
        "$PYTHON_BIN" -m pip install "$@" -t "$TARGET_DIR"
    elif "$PYTHON_BIN" -m ensurepip --upgrade >/dev/null 2>&1; then
        "$PYTHON_BIN" -m pip install "$@" -t "$TARGET_DIR"
    elif command -v uv >/dev/null 2>&1; then
        uv pip install "$@" --target "$TARGET_DIR"
    else
        echo "pip is not available and uv is missing; cannot bundle deps" >&2
        exit 1
    fi
    exit 0
fi

PYWIRE_REPO="https://github.com/pywire/pywire.git"
PYWIRE_LS_REPO="https://github.com/pywire/pywire-language-server.git"

if [ "$PYWIRE_RELEASE" = "1" ]; then
    echo "Release mode detected. Fetching latest tags..."
    PYWIRE_REF="$(get_latest_tag "$PYWIRE_REPO")"
    PYWIRE_LS_REF="$(get_latest_tag "$PYWIRE_LS_REPO")"
    echo "Using pywire@$PYWIRE_REF and pywire-language-server@$PYWIRE_LS_REF"
else
    PYWIRE_REF="main"
    PYWIRE_LS_REF="main"
fi

if command -v uv >/dev/null 2>&1; then
    uv pip install \
        pygls \
        pyright \
        "git+$PYWIRE_REPO@$PYWIRE_REF" \
        "git+$PYWIRE_LS_REPO@$PYWIRE_LS_REF" \
        --target "$TARGET_DIR"
else
    "$PYTHON_BIN" -m pip install \
        pygls \
        pyright \
        "git+$PYWIRE_REPO@$PYWIRE_REF" \
        "git+$PYWIRE_LS_REPO@$PYWIRE_LS_REF" \
        -t "$TARGET_DIR"
fi

